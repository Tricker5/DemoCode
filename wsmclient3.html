<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>wsmclient3</title>
</head>
<body>
    <div>
        <input id="msg" type="text">
        <button id="connect" onclick="dConnect();">Connect</button>
        <button id="send" onclick="Send();">Send</button>
        <button id="close" onclick="Close();">Close</button>
    </div> 
    <div id = "connectstatus">

    </div>
    <br> 
    <div>
        <button id="dbtest" onclick="dbtest();">数据库查询测试</button>
    </div>  
    <div>
        <table border = 1>
            <tr align = "center">
                <td>监控类型</td>
                <td>监控范围</td>
            </tr>
            <tr align = "left">
                <td><input type="radio" name="motype" id="none" value="none" onclick="setMoType();">无</td>
                <td></td>
            </tr>
            <tr align = "left">
                <td><input type="radio" name="motype" id="line" value="line" onclick="setMoType();">线体</td>
                <td>选择监控线体：
                    <select name="lineid" id="lineid" onchange="setMoLine();">
                        <option selected="selected" disabled="disabled" style="display:none" value=""></option>
                        <option value="4">虚拟线体0</option>
                        <option value="33">虚拟线体1</option>
                        <option value="62">虚拟线体2</option>
                        <option value="91">虚拟线体3</option>
                        <option value="120">虚拟线体4</option>
                        <option value="149">虚拟线体5</option>
                        <option value="178">虚拟线体6</option>
                        <option value="207">虚拟线体7</option>
                        <option value="236">虚拟线体8</option>
                        <option value="265">虚拟线体9</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><input type="radio" name="motype" id="station" value="station" onclick="setMoType();">工位</td>
                <td>
                    请输入工位id（5～99）
                    <input type="text" name = "stationid" id="stationid">
                    <button onclick="setMoStation();">确定</button>
                </td>
            </tr>
        </table>
    </div>
    <div id = "tablediv">

    </div>
</body>
<script>
    var dbClientSocket;

    const NORMALSTR = 0;
    const MOTYPESET =1;
    const DBTEST = 2;
    const MOARR = 3;
    const MOLINESET = 4;
    const MOSTATIONSET = 5;

    const TASK_MOLINE = 13;
    const TASK_MOSTATION = 14;

    function dConnect(){
        try{
            if(!dbClientSocket){
                dbClientSocket = new WebSocket("ws://0.0.0.0:7777");
                dbClientSocket.onopen= dOpen;
                dbClientSocket.onerror = dError;
            }
        }catch(e){
            alert("error"+e.data);
            return;
        }
           
    }
    function dOpen(){
        alert('连接成功！');
        dbClientSocket.onmessage= dMessage;
        dbClientSocket.onclose = dClose;
    }
    function dError(e){
        alert('连接错误！');
        dbClientSocket = null;
    }
    function dMessage(msg){
        data = JSON.parse(msg.data);
        switch(data["head"]){
            case NORMALSTR:
                alert("服务器说："+data["body"]);
                break;
            case DBTEST:
                testArr(data["body"]);
                break;
            case MOARR:
                printMoArr(data["body"]);
                break;
            default:
                break;
        }
    }

    function dClose(){
        alert('连接关闭！');
        dbClientSocket = null;
    }
    function Send(){
        jsonDataSend(NORMALSTR, document.getElementById("msg").value);
    }
    function Close(){
        dbClientSocket.close();
    }

    /*
    * 客户端配置部分函数
    * 配置监控类型setMoType()、配置监控线体setMoLine()、配置监控工位setMoStation()
    */
    function setMoType(){
        var motype_radio = document.getElementsByName("motype");
        for(i = 0; i < motype_radio.length;i++){
            if(motype_radio[i].checked){
                motype = motype_radio[i].value;
            }
        }
        if(motype == "none")
            document.getElementById("tablediv").innerHTML = "";
        jsonDataSend(MOTYPESET, motype);
    }

    function setMoLine(){
        lineid = document.getElementById("lineid").value; 
        jsonDataSend(MOLINESET, lineid);
    }
    
    function setMoStation(){
        stationid = document.getElementById("stationid").value;
        if(stationid >= 5 && stationid <= 99)
            jsonDataSend(MOSTATIONSET, stationid);
        else
            alert("请输入5～99之内的有效ID！");
    }

    /*
    * 数据库查询测试部分函数
    */
    function dbtest(){
        jsonDataSend(DBTEST, "请求测试");
    }

    function testArr(data){
        alert(jsonToStr(data));  
        //console.log(jsonToStr(data));
    }

    function printMoArr(body){
        var tablediv = document.getElementById("tablediv");
        data = body.moarr;
        time = body.time;
        var ptime =  "<p>监控时间："+time+"</p>";

        if(body.motype == TASK_MOLINE){
            var table = 
                "<table align='center' border=1 bordercolor='purple'>"+
                    "<tr align='center' height='40'>"+
                    "<td align='center' width = '200'>频道插槽</td>"+
                    "<td align='center' width = '200'>频道端口</td>"+
                    "<td align='center' width = '200'>频道类型</td>"+
                    "<td align='center' width = '200'>设备SN号</td>"+
                    "<td align='center' width = '200'>实时状态</td>"+
                    "<td align='center' width = '200'>区域ID</td>"+
                    "<td align='center' width = '200'>所在区域</td>"+
                    "</tr>";
        }else if (body.motype == TASK_MOSTATION){
            var table = 
                "<table align='center' border=1 bordercolor='purple'>"+
                    "<tr align='center' height='40'>"+
                    "<td align='center' width = '200'>工位ID</td>"+
                    "<td align='center' width = '200'>实时状态</td>"+
                    "<td align='center' width = '200'>监控点ID</td>"+
                    "<td align='center' width = '200'>监控点名称</td>"+
                    "<td align='center' width = '200'>设备SN号</td>"+
                    "<td align='center' width = '200'>频道插槽</td>"+
                    "<td align='center' width = '200'>频道端口</td>"+
                    "<td align='center' width = '200'>频道类型</td>"+
                    "</tr>";
        }

        var printarr = "";
        //console.log("MEOW! ")            
        for(var i in data){
            printarr += "<tr align='center' height='40'>";
            for(var j in data[i]){
                printarr += "<td align='center' width = '200'>"+data[i][j]+"</td>";
                //console.log("ohhhhh!");
            }
            printarr += "</tr>";
        }
        var printlinemo = ptime + table + printarr + "</table>";
        tablediv.innerHTML = printlinemo;

    }
    
    //将json对象转化成易读的字符串
    function jsonToStr(data){
        var str ="";
        for(var i in data){
            for(var j in data[i]){
                str=str+data[i][j]+" ";
            }
            str+="\n";
        }
        return str;
    }

    //打包发出json字符串
    function jsonDataSend(head, body){
        data = {
            "head" : head, 
            "body" : body
        }
        dbClientSocket.send(JSON.stringify(data));
    }
        
        
</script>
</html>