<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>wsmclient1</title>
</head>
<body>
    <div>
        <input id="msg" type="text">
        <button id="connect" onclick="dConnect();">Connect</button>
        <button id="send" onclick="Send();">Send</button>
        <button id="close" onclick="Close();">Close</button>
    </div> 
    <br> 
    <div>
        <button id="dbtest" onclick="dbtest();">数据库查询测试</button>
    </div>  
    <div>
        选择监控线体：
        <select name="lineselect" id="lineselect" onchange="setMonLine();">
            <option selected="selected" disabled="disabled" style="display:none" value=""></option>
            <option value="4">虚拟线体0</option>
            <option value="33">虚拟线体1</option>
            <option value="62">虚拟线体2</option>
            <option value="91">虚拟线体3</option>
            <option value="120">虚拟线体4</option>
            <option value="149">虚拟线体5</option>
            <option value="178">虚拟线体6</option>
            <option value="207">虚拟线体7</option>
            <option value="236">虚拟线体8</option>
            <option value="265">虚拟线体9</option>
        </select>
    </div>
    <div id = "tablediv">

    </div>
</body>
<script>
    var dbClientSocket;

    const NORMALSTR = 0;
    const MONITORARR =1;
    const DBTEST = 2;
    const MOLINESET = 3;
    const MOLINEARR = 4;

    function dConnect(){
        try{
            if(!dbClientSocket){
                dbClientSocket = new WebSocket("ws://0.0.0.0:7777");
                dbClientSocket.onopen= dOpen;
                dbClientSocket.onerror = dError;
            }
        }catch(e){
            alert("error"+e.data);
            return;
        }
           
    }
    function dOpen(){
        alert('连接成功！');
        dbClientSocket.onmessage= dMessage;
        dbClientSocket.onclose = dClose;
    }
    function dError(e){
        alert('连接错误！');
        dbClientSocket = null;
    }
    function dMessage(msg){
        data = JSON.parse(msg.data);
        switch(data["head"]){
            case NORMALSTR:
                alert("服务器说："+data["body"]);
                break;
            case DBTEST:
                testTable(data["body"]);
                break;
            case MOLINEARR:
                //console.log("WOW! ");
                printarr(data["body"]);
                break;
            default:
                break;
        }
    }

    function dClose(){
        alert('连接关闭！');
        dbClientSocket = null;
    }
    function Send(){
        jsonDataSend(NORMALSTR, document.getElementById("msg").value);
    }
    function Close(){
        dbClientSocket.close();
    }

    function setMonLine(){
        lineid = document.getElementById("lineselect").value; 
        jsonDataSend(MOLINESET, lineid);
    }

    function dbtest(){
        jsonDataSend(DBTEST, "请求测试");
    }

    //打包发出json字符串
    function jsonDataSend(head, body){
        data = {
            "head" : head, 
            "body" : body
        }
        dbClientSocket.send(JSON.stringify(data));
    }

    function testTable(data){
        alert(jsonToStr(data));  
    }

    function printarr(data){
        var tablediv = document.getElementById("tablediv");
        var table = "<table align='center' border=1 bordercolor='purple'>";
        //console.log("MEOW! ")            
        for(var i in data){
            table += "<tr align='center' height='40'>";
            for(var j in data[i]){
                table += "<td align='center' width = '200'>"+data[i][j]+"</td>";
                //console.log("ohhhhh!");
            }
            table += "</tr>";
        }
        table += "</table>";

        tablediv.innerHTML = table;
        table = "";
    }
    
    //将json对象转化成易读的字符串
    function jsonToStr(data){
        var str ="";
        for(var i in data){
            for(var j in data[i]){
                str=str+data[i][j]+" ";
            }
            str+="\n";
        }
        return str;
    }
        
        
</script>
</html>